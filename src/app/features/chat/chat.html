<section class="chat">
  <div class="home-grid">
    <div class="about-card blue-skin">
      <!-- Botón Volver al Home -->
      <button (click)="goHome()" class="btn btn-back">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 20 20"
          fill="currentColor"
          class="icon"
        >
          <path
            fill-rule="evenodd"
            d="M9.293 2.293a1 1 0 011.414 0l7 7A1 1 0 0117 10.707V16.5a1.5 1.5 0 01-1.5 1.5h-3.5a.5.5 0 01-.5-.5v-4.5a.5.5 0 00-.5-.5h-2a.5.5 0 00-.5.5V17a.5.5 0 01-.5.5H5a1.5 1.5 0 01-1.5-1.5V10.707a1 1 0 01.293-.707l7-7z"
            clip-rule="evenodd"
          />
        </svg>
        <span>Volver al Home</span>
      </button>

      <!-- Botón Limpiar Chat (Solo Admin) -->
      @if(isAdmin$ | async){
      <button class="btn btn-clear" (click)="clearChat()">Limpiar Chat</button>
      }

      <div class="hero chat-header">
        <!-- Añadida clase chat-header -->
        <h2>Chat General</h2>
      </div>

      <!-- Quitamos el div .stream -->
      <div class="chat-area">
        <!-- Nuevo contenedor -->
        <div class="messages" #messagesRef>
          @for (m of messages$ | async; track m.id) {
          <div
            class="msg"
            [class.me]="m.uid === meUid"
            [class.other]="m.uid !== meUid"
          >
            <div class="meta">
              <span class="who"
                >{{ m.uid === meUid ? 'Tú' : (m.email || 'Anónimo') }}</span
              >
              <!-- La hora se ha movido fuera del .meta -->
            </div>
            <div class="text">{{ m.text }}</div>

            <!-- La hora ahora está aquí, después del texto -->
            @if (m.createdAt?.toDate) {
            <!-- Formato de fecha mejorado -->
            <span class="time">
              {{ m.createdAt.toDate() | date:'HH:mm' }}
            </span>
            } @else {
            <span class="time">Enviando...</span>
            }
          </div>
          } @empty {
          <p class="empty-chat">No hay mensajes aún. ¡Escribe el primero!</p>
          }
        </div>

        <form class="composer" (ngSubmit)="send()">
          <input
            type="text"
            placeholder="Escribe un mensaje..."
            [(ngModel)]="text"
            name="text"
            autocomplete="off"
            maxlength="500"
            [disabled]="sending()"
          />
          <button
            class="btn btn-send"
            type="submit"
            [disabled]="sending() || !text.trim()"
          >
            <!-- Icono SVG de Enviar -->
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 20 20"
              fill="currentColor"
              class="send-icon"
            >
              <path
                d="M3.105 2.289a.75.75 0 00-.826.95l1.414 4.949a.75.75 0 00.13 0l6.175-1.742a.75.75 0 01.387.387L8.75 12.25l.13.001a.75.75 0 00.95-.826l1.414-4.95a.75.75 0 00-.95-.95l-4.95 1.414a.75.75 0 00-.826.95l1.414 4.949-.001.13-1.742 6.175a.75.75 0 00.387.387l6.175-1.742.001.13a.75.75 0 00.95-.826l1.414-4.949a.75.75 0 00-.95-.95l-4.949 1.414z"
              />
            </svg>
          </button>
        </form>

        @if (error()) {
        <p class="error-message">{{ error() }}</p>
        }
      </div>
      <!-- Fin chat-area -->
    </div>
    <!-- Fin blue-skin -->
  </div>
  <!-- Fin home-grid -->
</section>
